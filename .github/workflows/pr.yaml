name: PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "**/*.hcl"
      - "**/*.tpl"
      - "**/*.yaml"
      - "**/*.yml"
      - ".github/workflows/**"

permissions:
  contents: read
  security-events: write

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: "1.14.5"
  TF_IN_AUTOMATION: "true"
  WORKDIR: "dynamic"

jobs:
  terraform:
    name: Terraform (fmt/validate)
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform fmt (check)
        id: fmt
        run: |
          set +e
          terraform fmt -check -diff -recursive > tf-fmt.txt 2>&1
          echo "exitcode=$?" >> $GITHUB_OUTPUT
          cat tf-fmt.txt
          exit 0

      - name: Terraform init (no backend)
        id: init
        working-directory: ${{ env.WORKDIR }}
        run: terraform init -backend=false -input=false -no-color

      - name: Terraform validate
        id: validate
        working-directory: ${{ env.WORKDIR }}
        run: terraform validate -no-color > tf-validate.txt 2>&1 || (cat tf-validate.txt && exit 1)

      - name: Upload terraform logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-logs
          path: |
            tf-fmt.txt
            tf-validate.txt
          if-no-files-found: ignore

      - name: Fail if fmt failed
        run: |
          if [ "${{ steps.fmt.outputs.exitcode }}" != "0" ]; then
            echo "terraform fmt issues detected."
            exit 1
          fi

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: v0.55.0

      - name: TFLint (run)
        id: tflint
        working-directory: dynamic
        run: |
          set +e
          tflint --init > tflint-init.txt 2>&1
          tflint -f compact > tflint.txt 2>&1
          echo "exitcode=$?" >> $GITHUB_OUTPUT
          echo "=== tflint --init ==="
          cat tflint-init.txt || true
          echo "=== tflint ==="
          cat tflint.txt || true
          exit 0

      - name: Upload tflint logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: tflint-logs
          path: |
            dynamic/tflint-init.txt
            dynamic/tflint.txt
          if-no-files-found: ignore

      - name: Fail if tflint failed
        run: |
          if [ "${{ steps.tflint.outputs.exitcode }}" != "0" ]; then
            echo "tflint issues detected."
            exit 1
          fi

  security:
    name: Security (tfsec + SARIF)
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Creates tfsec.sarif reliably
      - name: tfsec (SARIF)
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec.sarif
          working_directory: dynamic
        continue-on-error: true

      - name: Upload tfsec SARIF to Code Scanning
        if: ${{ always() && hashFiles('tfsec.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: tfsec.sarif

      - name: Upload SARIF artifact (for PR summary)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: sarif
          path: tfsec.sarif
          if-no-files-found: ignore

  review:
    name: PR Review Summary (Upsert Comment)
    runs-on: ubuntu-latest
    # ✅ key fix: always run even if dependencies failed
    if: ${{ always() && !github.event.pull_request.draft }}
    needs: [terraform, tflint, security]
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    steps:
      - name: Download terraform logs
        if: ${{ always() }}
        uses: actions/download-artifact@v4
        with:
          name: terraform-logs
          path: artifacts/terraform
        continue-on-error: true

      - name: Download tflint logs
        if: ${{ always() }}
        uses: actions/download-artifact@v4
        with:
          name: tflint-logs
          path: artifacts/tflint
        continue-on-error: true

      - name: Download SARIF
        if: ${{ always() }}
        uses: actions/download-artifact@v4
        with:
          name: sarif
          path: artifacts/sarif
        continue-on-error: true

      - name: Upsert PR Comment (badges + summaries)
        uses: actions/github-script@v7
        with:
          script: |
            const marker = "<!-- terraform-pr-review -->";
            const fs = require("fs");
            const path = require("path");

            const terraformResult = "${{ needs.terraform.result }}"; // success|failure|skipped|cancelled
            const tflintResult    = "${{ needs.tflint.result }}";
            const securityResult  = "${{ needs.security.result }}";

            const readFileSafe = (p) => {
              try { return fs.readFileSync(p, "utf8"); } catch { return ""; }
            };

            const fmtOutput = readFileSafe(path.join(process.cwd(), "artifacts/terraform/tf-fmt.txt")).trim();
            const validateOutput = readFileSafe(path.join(process.cwd(), "artifacts/terraform/tf-validate.txt")).trim();
            const tflintOutput = readFileSafe(path.join(process.cwd(), "artifacts/tflint/tflint.txt")).trim();

            // tfsec SARIF summary (count results)
            const tfsecSarifPath = path.join(process.cwd(), "artifacts/sarif/tfsec.sarif");
            let tfsecCount = null;
            try {
              if (fs.existsSync(tfsecSarifPath)) {
                const sarif = JSON.parse(fs.readFileSync(tfsecSarifPath, "utf8"));
                const runs = Array.isArray(sarif.runs) ? sarif.runs : [];
                tfsecCount = runs.reduce((sum, r) => sum + (Array.isArray(r.results) ? r.results.length : 0), 0);
              }
            } catch (e) {
              tfsecCount = null;
            }

            const ok = (r) => r === "success";
            const badge = (label, isOk, okText="pass", badText="fail") => {
              const status = isOk ? okText : badText;
              const color = isOk ? "brightgreen" : "red";
              return `![${label}](https://img.shields.io/badge/${encodeURIComponent(label)}-${encodeURIComponent(status)}-${color})`;
            };

            const secOk = (tfsecCount === null) ? ok(securityResult) : (tfsecCount === 0);
            const badges = [
              badge("terraform", ok(terraformResult)),
              badge("tflint", ok(tflintResult)),
              badge("tfsec", secOk, "clean", "findings")
            ].join(" ");

            const details = (title, content) => {
              const body = (content && content.length) ? content : "No output captured.";
              return [
                `### ${title}`,
                `<details><summary>Show details</summary>`,
                "",
                "```",
                body.slice(0, 12000),
                "```",
                "</details>",
                ""
              ].join("\n");
            };

            const tfsecLine =
              tfsecCount === null ? `- **tfsec**: (no SARIF found / unreadable)` :
              tfsecCount === 0 ? `- **tfsec**: 0 findings` :
              `- **tfsec**: ${tfsecCount} finding(s)`;

            const body = [
              marker,
              "## Terraform PR Review",
              "",
              badges,
              "",
              "### Job Results",
              `- **terraform**: ${terraformResult}`,
              `- **tflint**: ${tflintResult}`,
              `- **security**: ${securityResult}`,
              tfsecLine,
              "",
              details("terraform fmt", fmtOutput),
              details("terraform validate", validateOutput),
              details("tflint", tflintOutput),
              tfsecCount === 0 ? "### tfsec ✅\nNo findings.\n" :
                (tfsecCount === null ? "### tfsec ⚠️\nSARIF missing/unreadable. Check the security job logs.\n"
                                     : "### tfsec ❌\nFindings are available in Code Scanning.\n"),
              "---",
              "_Automated review by CI_"
            ].join("\n");

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner, repo, issue_number, per_page: 100
            });

            const existing = comments.find(c =>
              (c.user?.login === "github-actions[bot]" || c.user?.type === "Bot") &&
              typeof c.body === "string" &&
              c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }